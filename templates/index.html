<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Deep Watch - Surveillance</title>
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <header>
      <div class="header-left">
        <h1>Deep Watch</h1>
        <nav class="header-nav">
          <a href="/" class="nav-link active">Live</a>
          <a href="/incidents_view" class="nav-link">Logs</a>
        </nav>
      </div>
      <div class="status" id="statusText">Checking…</div>
    </header>

    <main>
      <section class="panel video">
        <div class="panel-header">Live Feed</div>
        <div class="panel-body video-container" id="videoContainer">
          <img id="stream" src="/video_feed" alt="Live stream" />
          <!-- visual Detection -->
          <div class="drowning-alert" id="drowningAlert">
            <svg width="20" height="22" viewBox="0 0 116.11 122.88" style="enable-background:new 0 0 116.11 122.88" xml:space="preserve">
              <g>
                <path fill="#fff" d="M74.82,109.04c-0.37,1.94-1.02,3.72-1.96,5.35c-0.97,1.67-2.24,3.18-3.8,4.5c-1.57,1.32-3.27,2.32-5.12,2.99 c-1.85,0.67-3.81,1-5.88,1c-2.08,0-4.04-0.34-5.88-1c-1.84-0.67-3.55-1.66-5.11-2.99c-1.57-1.33-2.83-2.83-3.8-4.5 c-0.97-1.67-1.63-3.51-1.99-5.53c-0.18-0.98,0.48-1.92,1.46-2.1c0.03,0,0.32-0.03,0.32-0.03h30.02c1,0,1.82,0.81,1.82,1.82 C74.89,108.72,74.86,108.88,74.82,109.04L74.82,109.04L74.82,109.04z M20.21,0.25c1.83-0.73,3.9,0.17,4.63,2 c0.73,1.83-0.17,3.9-2,4.63c-3.96,1.58-7.28,3.77-9.93,6.61c-2.64,2.84-4.63,6.36-5.93,10.59c-0.58,1.88-2.58,2.94-4.46,2.36 c-1.88-0.58-2.94-2.58-2.36-4.46c1.63-5.3,4.15-9.74,7.52-13.36C11.05,5.01,15.24,2.23,20.21,0.25L20.21,0.25z M93.27,6.88 c-1.83-0.73-2.73-2.8-2-4.63c0.73-1.83,2.8-2.73,4.63-2c4.97,1.98,9.16,4.76,12.53,8.38c3.37,3.63,5.9,8.07,7.52,13.36 c0.58,1.88-0.48,3.88-2.36,4.46c-1.88,0.58-3.88-0.48-4.46-2.36c-1.3-4.24-3.29-7.76-5.93-10.59 C100.55,10.65,97.23,8.46,93.27,6.88L93.27,6.88z M71.91,11.94c2.04,0.81,4,1.78,5.88,2.91c0.07,0.05,0.15,0.09,0.22,0.14 c1.8,1.11,3.48,2.33,5.02,3.65c3.29,2.83,6.03,6.15,8.2,9.91c1.08,1.88,2.01,3.84,2.78,5.86l0,0c0.79,2.09,1.38,4.22,1.78,6.41 c0.39,2.2,0.59,4.45,0.59,6.76c0,4.56,0,7.03,0,7.33c0.01,2.34,0.02,4.63,0.04,6.86v0.02l0,0c0.01,2.02,0.14,4.05,0.39,6.08 c0.25,2.01,0.61,3.95,1.08,5.82l0,0c0.47,1.84,1.11,3.62,1.9,5.32c0.82,1.75,1.82,3.47,2.99,5.14l0.01,0 c1.16,1.64,2.61,3.27,4.35,4.87c1.8,1.65,3.88,3.28,6.26,4.86c1.36,0.91,1.73,2.76,0.81,4.12c-0.57,0.85-1.51,1.32-2.47,1.32v0.01 l-26.85,0H58.06H31.21H4.37c-1.65,0-2.98-1.33-2.98-2.98c0-1.08,0.58-2.03,1.44-2.55c2.41-1.63,4.48-3.25,6.21-4.85 c1.72-1.59,3.16-3.22,4.32-4.9c0.03-0.05,0.07-0.1,0.11-0.14c1.12-1.64,2.08-3.31,2.87-5.01c0.81-1.73,1.46-3.51,1.94-5.34 c0.01-0.04,0.02-0.08,0.03-0.11c0.46-1.78,0.81-3.66,1.05-5.63c0.24-1.98,0.37-4.03,0.37-6.14v-14.1c0-2.27,0.2-4.52,0.61-6.77 c0.41-2.24,1-4.39,1.79-6.44c0.78-2.05,1.72-4.02,2.81-5.9c2.2-3.8,4.93-7.09,8.27-9.94c1.63-1.39,3.39-2.66,5.28-3.79 c1.91-1.14,3.89-2.1,5.93-2.88c1.42-0.54,2.89-0.99,4.39-1.36c0.51-1.79,1.39-3.24,2.64-4.35c1.72-1.53,3.98-2.29,6.79-2.26 c2.78,0.02,5.03,0.79,6.73,2.32C70.98,11.56,63.5,8.62,71.91,11.94L71.91,11.94z"/>
              </g>
            </svg>
            <span>Drowning Detected</span>
          </div>
          <button id="toggleSirenBtn" class="toggle-siren-btn" type="button" title="Silence siren">Mute Siren</button>
        </div>
      </section>

      <audio id="sirenAudio" loop>
        <source src="/static/alert.mp3" type="audio/mpeg">
      </audio>

      <section class="panel info">
        <div class="panel-header">System Statistics</div>
        <div class="panel-body">
          <div class="status-area">
            <span>Status:</span> <span id="simpleStatus">Loading…</span>
          </div>
          
          <div class="stats-section">
            <div class="stats-header">Detection</div>
            <div class="stat-row">
              <span class="stat-label">People in Frame:</span>
              <span class="stat-value" id="activeTracks">0</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Total Tracked:</span>
              <span class="stat-value" id="peopleTracked">0</span>
            </div>
            <div class="stat-row alert-row" id="alertRow">
              <span class="stat-label">⚠️ Drowning Alerts:</span>
              <span class="stat-value alert-value" id="drowningAlerts">0</span>
            </div>
            <div class="alert-ids" id="alertIds"></div>
          </div>

          <div class="stats-section">
            <div class="stats-header">Performance</div>
            <div class="stat-row">
              <span class="stat-label">FPS:</span>
              <span class="stat-value" id="fps">0.0</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Frames Total:</span>
              <span class="stat-value" id="frameCount">0</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Frames Processed:</span>
              <span class="stat-value" id="processedFrames">0</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Frames Skipped:</span>
              <span class="stat-value" id="skippedFrames">0</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">LSTM Inferences:</span>
              <span class="stat-value" id="lstmInferences">0</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Avg Inference:</span>
              <span class="stat-value"><span id="avgInference">0</span> ms</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Uptime:</span>
              <span class="stat-value" id="uptime">0s</span>
            </div>
          </div>

          <div class="stats-section">
            <div class="stats-header">System</div>
            <div class="stat-row">
              <span class="stat-label">Camera:</span>
              <span class="stat-value" id="cameraStatus">—</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Model:</span>
              <span class="stat-value" id="modelStatus">—</span>
            </div>
          </div>

          <div class="hint">Prediction is overlaid on the video stream.</div>
        </div>
      </section>
    </main>

    <footer>
      <div>© Deep Watch</div>
    </footer>

    <script>
      //Siren control logic
      let sirenEnabled = true;
      let sirenSilenced = false;
      let sirenActive = false;
      const sirenAudio = document.getElementById("sirenAudio");

      function startSiren() {
        if (!sirenEnabled || sirenSilenced) return;
        
        if (sirenActive) return;
        sirenActive = true;
        
        try {
          sirenAudio.currentTime = 0;
          sirenAudio.play().catch(err => {
            console.warn("Browser blocked autoplay. User interaction needed:", err);
            sirenActive = false;
          });
        } catch (e) {
          sirenActive = false;
          console.error("Error starting siren:", e);
        }
      }

      function stopSiren() {
        if (!sirenActive) return;
        sirenActive = false;
        
        try {
          sirenAudio.pause();
          sirenAudio.currentTime = 0;
        } catch (e) {
          console.error("Error stopping siren:", e);
        }
      }

      function toggleSilence() {
        sirenSilenced = !sirenSilenced;
        const btn = document.getElementById("toggleSirenBtn");
        if (sirenSilenced) {
          stopSiren();
          btn.textContent = "Unmute Siren";
        } else {
          btn.textContent = "Mute Siren";
          startSiren();
        }
      }

      document.getElementById("toggleSirenBtn").addEventListener("click", toggleSilence);



      function formatUptime(seconds) {
        if (seconds < 60) return `${seconds}s`;
        if (seconds < 3600) {
          const m = Math.floor(seconds / 60);
          const s = seconds % 60;
          return `${m}m ${s}s`;
        }
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        return `${h}h ${m}m`;
      }

      async function refreshHealth() {
        const statusEl = document.getElementById("simpleStatus");
        const headerEl = document.getElementById("statusText");
        try {
          const res = await fetch("/health");
          const data = await res.json();
          const ok = data && data.status === "ok";
          const text = ok ? "Service OK" : "Service Unavailable";
          statusEl.textContent = text;
          headerEl.textContent = text;
        } catch (e) {
          statusEl.textContent = "Service Unavailable";
          headerEl.textContent = "Service Unavailable";
        }
      }

      async function refreshStats() {
        try {
          const res = await fetch("/stats");
          const data = await res.json();
          
          // Detection stats
          document.getElementById("activeTracks").textContent = data.active_tracks || 0;
          document.getElementById("peopleTracked").textContent = data.people_tracked || 0;
          
          const alertCount = data.drowning_alerts || 0;
          const alertEl = document.getElementById("drowningAlerts");
          const alertRow = document.getElementById("alertRow");
          const alertIds = document.getElementById("alertIds");
          const videoContainer = document.getElementById("videoContainer");
          const drowningAlert = document.getElementById("drowningAlert");
          const toggleSirenBtn = document.getElementById("toggleSirenBtn");
          
          alertEl.textContent = alertCount;
          if (alertCount > 0) {
            alertRow.classList.add("active-alert");
            alertIds.textContent = `Track IDs: ${data.drowning_track_ids.join(", ")}`;
            alertIds.style.display = "block";
            drowningAlert.style.display = "flex";
            toggleSirenBtn.style.display = "block";
            startSiren();
          } else {
            alertRow.classList.remove("active-alert");
            alertIds.style.display = "none";
            drowningAlert.style.display = "none";
            toggleSirenBtn.style.display = "none";
            stopSiren();
            sirenSilenced = false;
            const btn = document.getElementById("toggleSirenBtn");
            btn.textContent = "Mute Siren";
          }
          
          // Performance stats
          document.getElementById("fps").textContent = data.fps?.toFixed(1) || "0.0";
          document.getElementById("frameCount").textContent = data.frame_count?.toLocaleString() || 0;
          document.getElementById("processedFrames").textContent = data.processed_frames?.toLocaleString() || 0;
          document.getElementById("skippedFrames").textContent = data.skipped_frames?.toLocaleString() || 0;
          document.getElementById("lstmInferences").textContent = data.lstm_inferences?.toLocaleString() || 0;
          document.getElementById("avgInference").textContent = data.avg_inference_ms?.toFixed(1) || "0";
          document.getElementById("uptime").textContent = formatUptime(data.uptime_seconds || 0);
          
          // System stats
          const cameraEl = document.getElementById("cameraStatus");
          const modelEl = document.getElementById("modelStatus");
          
          cameraEl.textContent = data.camera_connected ? "Connected" : "Disconnected";
          cameraEl.className = "stat-value " + (data.camera_connected ? "status-ok" : "status-error");
          
          modelEl.textContent = data.model_loaded ? "Loaded" : "Not Loaded";
          modelEl.className = "stat-value " + (data.model_loaded ? "status-ok" : "status-warning");
          
        } catch (e) {
          console.error("Failed to fetch stats:", e);
        }
      }

      refreshHealth();
      refreshStats();
      setInterval(refreshHealth, 5000);
      setInterval(refreshStats, 500);
    </script>
  </body>
</html>
